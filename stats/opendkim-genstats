#!/bin/sh
#
# Copyright (c) 2010, The OpenDKIM Project.  All rights reserved.
#
# $Id: opendkim-genstats,v 1.1.2.1 2010/08/30 07:33:40 cm-msk Exp $
#
# Script to generate some HTML-ized statistics for OpenDKIM

###
### Setup
###

# Command to perform a MySQL query and output HTML
MYSQL_CMD="/usr/local/bin/mysql --html"

# Database name
DB=opendkim

# Database user
USER=opendkim

# Database user's password
PASSWORD=password

# Where to write the report
OUTPUT=/var/www/docs/opendkim/report.html

###
### NO user-serviceable parts beyond this point
###

MYSQL="$MYSQL_CMD --user=$USER --password=$PASSWORD --database=$DB"

# output a header
cat > $OUTPUT << EOF
<html>
  <head>
   <title>
    OpenDKIM Statistics Report
   </title>
  </head>

  <body>
EOF

echo "<b>OpenDKIM Statistics Report generated at `date` </b> <br>" >> $OUTPUT

echo "<p>Total records (messages) received: <br>" >> $OUTPUT
$MYSQL --execute="select count(*) as count from messages" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Reporting hosts and record counts: <br>" >> $OUTPUT
$MYSQL --execute="select reporters.name as 'reporter', count(*) as 'messages' from messages join reporters on messages.reporter = reporters.id group by messages.reporter order by count(*) desc" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Overall message signature counts: <br>" >> $OUTPUT
$MYSQL --execute="select sigcount, count(*) as messages from messages group by sigcount" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Signature algorithm use: <br>" >> $OUTPUT
$MYSQL --execute="select if(algorithm = 0, 'rsa-sha1', 'rsa-sha256') as 'signing algorithm', count(algorithm) as count from signatures group by algorithm" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Header canonicalization use: <br>" >> $OUTPUT
$MYSQL --execute="select if(hdr_canon = 0, 'simple', 'relaxed') as canonicalization, count(hdr_canon) as count from signatures group by hdr_canon" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Body canonicalization use: <br>" >> $OUTPUT
$MYSQL --execute="select if(body_canon = 0, 'simple', 'relaxed') as canonicalization, count(body_canon) as count from signatures group by body_canon" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Overall pass/fail rate for signed mail: <br>" >> $OUTPUT
$MYSQL --execute="select count(*) as signatures, sum(ignored) as ignored, sum(pass) as passed, sum(fail_body) as 'failed(body)' from signatures" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Overall pass/fail rate for signed mail, excluding list traffic: <br>" >> $OUTPUT
$MYSQL --execute="select count(*) as signatures, sum(ignored) as ignored, sum(passed) as passed, sum(fail_body) as 'failed(body)' from signatures join messages on messages.id = signaures.message where messages.mailing_list = 0" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Count of unique signing domains in sample: <br>" >> $OUTPUT
$MYSQL --execute="select count(distinct from_domain) as domains from messages where anonymous = 0" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Top 10 signing domains by signature count: <br>" >> $OUTPUT
$MYSQL --execute="select from_domain, sum(sigcount) as signatures, sum(passed) as passed from messages where anonymous = 0 group by from_domain order by sum(sigcount) desc limit 10" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>MLM/non-MLM signature comparison: <br>" >> $OUTPUT
$MYSQL --execute="select count(*) as signatures, sum(passed) as passed, 100*sum(passed)/count(*) as '%pass' from signatures join messages on messages.id = signatures.message group by messages.mailing_list" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Correlation of IP addresses to signed From: domains: <br>" >> $OUTPUT
$MYSQL --execute="select ipaddr, count(distinct from_domain) as domains from messages where sigcount > 0 and anonymous == 0 group by ipaddr order by domains desc limit 10" >> $OUTPUT
echo "</p>" >> $OUTPUT

# output a footer
cat >> $OUTPUT << EOF
  </body>
</html>
EOF

# all done!
exit 0

### FINISH ME -- stuff not converted from the old schema yet

echo "<p>Various key record statistics: <br>" >> $OUTPUT
echo "(g= statistics removed until next release) <br>" >> $OUTPUT
$MYSQL --execute="select sum(key_t) as 't=', sum(key_syntax) as 'syntax errors', sum(key_nx) as 'NXDOMAIN' from opendkim_statistics" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Various signature header field statistics: <br>" >> $OUTPUT
$MYSQL --execute="select sum(sig_t) as 't=', sum(sig_t_future) as 't= > now', sum(sig_x) as 'x=', sum(sig_l) as 'l=', sum(sig_z) as 'z=' from opendkim_statistics" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Top 10 signing domains by passing signature percentage: <br>" >> $OUTPUT
$MYSQL --execute="select from_domain, sum(sigs_total) as signatures, 100*sum(sigs_pass)/sum(sigs_total) as pct_passed from opendkim_statistics where sigs_total > 0 group by from_domain order by pct_passed desc, signatures desc limit 10" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Top 10 signing domains by failed signature percentage: <br>" >> $OUTPUT
$MYSQL --execute="select from_domain, sum(sigs_total) as signatures, 100*sum(sigs_fail)/sum(sigs_total) as pct_failed from opendkim_statistics where sigs_total > 0 group by from_domain order by pct_failed desc, signatures desc limit 10" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>ADSP policies found and failures: <br>" >> $OUTPUT
$MYSQL --execute="select sum(adsp) as passed, sum(adsp_fail) as 'failed all', sum(adsp_discardable) as 'failed discardable' from opendkim_statistics" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo "<p>Author vs. third-party signatures: <br>" >> $OUTPUT
$MYSQL --execute="select sum(author_sigs) as 'author sigs', sum(author_sigs_fail) as 'failed author sigs', 100*sum(author_sigs_fail)/sum(author_sigs) as '% failed', sum(tp_sigs) as 'third-party sigs', sum(tp_sigs_fail) as 'failed third-party sigs', 100*sum(tp_sigs_fail)/sum(tp_sigs) as '% failed' from opendkim_statistics" >> $OUTPUT
echo "</p>" >> $OUTPUT
