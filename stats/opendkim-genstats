#!/bin/sh
#
# Copyright (c) 2010, The OpenDKIM Project.  All rights reserved.
#
# $Id: opendkim-genstats,v 1.26 2010/10/27 06:18:45 cm-msk Exp $
#
# Script to generate some HTML-ized statistics for OpenDKIM

###
### Setup
###

# Command to perform a MySQL query and output HTML
MYSQL_CMD="mysql --html"

# Database name
DB=${OPENDKIM_DB:-opendkim}

# Database user
USER=${OPENDKIM_USER:-opendkim}

# Database user's password
PASSWORD=${OPENDKIM_PASSWORD:-password}

# Where to write the report
REALOUTPUT=${OPENDKIM_OUTPUT:-/var/www/docs/opendkim/report.html}
OUTPUT=${REALOUTPUT}.$$

###
### NO user-serviceable parts beyond this point
###

MYSQL="$MYSQL_CMD --user=$USER --password=$PASSWORD --database=$DB"

# output a header
cat > $OUTPUT << EOF
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
  <head>
   <title>
    OpenDKIM Statistics Report
   </title>
  </head>

  <body>
EOF

echo "<h1>OpenDKIM Statistics Report generated at `date` </h1>" >> $OUTPUT
echo "<hr>" >> $OUTPUT
echo "<ul>" >> $OUTPUT
echo '<li> <a href="#total_records">Total messages received</a>' >> $OUTPUT
echo '<li> <a href="#reporters">Reporting hosts and record counts</a>' >> $OUTPUT
echo '<li> <a href="#signature_counts">Overall message signature counts</a>' >> $OUTPUT
echo '<li> <a href="#algorithm_use">Signature algorithm use</a>' >> $OUTPUT
echo '<li> <a href="#hdr_canon">Header canonicalization use</a>' >> $OUTPUT
echo '<li> <a href="#body_canon">Body canonicalization use</a>' >> $OUTPUT
echo '<li> <a href="#sig_props">Signature properties</a>' >> $OUTPUT
echo '<li> <a href="#l_tag">Use of "l=" tag</a>' >> $OUTPUT
echo '<li> <a href="#i_tag">Use of "i=" tag</a>' >> $OUTPUT
echo '<li> <a href="#key_sizes">Distribution of key sizes</a>' >> $OUTPUT
echo '<li> <a href="#key_props">Key properties</a>' >> $OUTPUT
echo '<li> <a href="#key_s">Use of "s=" in keys</a>' >> $OUTPUT
echo '<li> <a href="#dnssec">DNSSEC results</a>' >> $OUTPUT
echo '<li> <a href="#passfail">Overall pass/fail rates for signed mail</a>' >> $OUTPUT
echo '<li> <a href="#passfail_nolist">Overall pass/fail rates for signed mail, excluding list traffic</a>' >> $OUTPUT
echo '<li> <a href="#error_codes">Top ten error codes</a>' >> $OUTPUT
echo '<li> <a href="#mlm_comparison">MLM/non-MLM signature comparison</a>' >> $OUTPUT
echo '<li> <a href="#adsp">ADSP policies found and failures</a>' >> $OUTPUT
echo '<li> <a href="#third_party">Author vs. third-party signatures, non-MLM traffic</a>' >> $OUTPUT
echo '<li> <a href="#third_party_list">Author vs. third-party signatures, MLM traffic</a>' >> $OUTPUT
echo '<li> <a href="#signed_fields">Signed header field frequency</a>' >> $OUTPUT
echo '<li> <a href="#unique_domains">Count of unique signed From: domains in sample</a>' >> $OUTPUT
echo '<li> <a href="#top_signing_domains">Top 10 signing domains by signature count</a>' >> $OUTPUT
echo '<li> <a href="#top_passing_domains">Top 10 signing domains by passing signature percentage</a>' >> $OUTPUT
echo '<li> <a href="#top_failing_domains">Top 10 signing domains by failed signature percentage</a>' >> $OUTPUT
echo '<li> <a href="#ip_correlation">Correlation of IP addresses to signed From: domains</a>' >> $OUTPUT
echo '<li> <a href="#received_correlation">Correlation of Received: count to signature successes</a>' >> $OUTPUT
echo '<li> <a href="#broken_headers">Most frequent header field changes resulting in signature failures</a>' >> $OUTPUT
echo '<li> <a href="#worst_adsp">Worst ADSP use</a>' >> $OUTPUT
echo '<li> <a href="#use_counts">Signing domain use counts</a>' >> $OUTPUT
echo '<li> <a href="#mime_type_correlation">Correlation of outer MIME types with pass/fail counts</a>' >> $OUTPUT
echo '<li> <a href="#mime_encoding_correlation">Correlation of outer MIME encodings with pass/fail counts</a>' >> $OUTPUT
echo '<li> <a href="#signing_trend">Trend in signing rates</a>' >> $OUTPUT
echo "</ul>" >> $OUTPUT
echo "<hr>" >> $OUTPUT

echo '<a name="total_records"></a>' >> $OUTPUT
echo "<p> Total records (messages) received: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as count, sum(if(sigcount > 0, 1, 0)) as signed from messages" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="reporters"></a>' >> $OUTPUT
echo "<p> Reporting hosts and record counts: </p>" >> $OUTPUT
$MYSQL --execute="select reporters.name as 'reporter', count(*) as 'messages', reporters.firstseen as 'since', max(msgtime) as 'last' from messages join reporters on messages.reporter = reporters.id group by messages.reporter order by count(*) desc" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="signature_counts"></a>' >> $OUTPUT
echo "<p> Overall message signature counts: </p>" >> $OUTPUT
$MYSQL --execute="select sigcount, count(*) as messages from messages group by sigcount" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="algorithm_use"></a>' >> $OUTPUT
echo "<p> Signature algorithm use: </p>" >> $OUTPUT
$MYSQL --execute="select if(algorithm = 0, 'rsa-sha1', 'rsa-sha256') as 'signing algorithm', count(algorithm) as count from signatures group by algorithm" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="hdr_canon"></a>' >> $OUTPUT
echo "<p> Header canonicalization use: </p>" >> $OUTPUT
$MYSQL --execute="select if(hdr_canon = 0, 'simple', 'relaxed') as canonicalization, count(hdr_canon) as count, count(distinct domain) as domains, sum(pass) as passed from signatures group by hdr_canon" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="body_canon"></a>' >> $OUTPUT
echo "<p> Body canonicalization use: </p>" >> $OUTPUT
$MYSQL --execute="select if(body_canon = 0, 'simple', 'relaxed') as canonicalization, count(body_canon) as count, count(distinct domain) as domains, sum(pass) as passed from signatures group by body_canon" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="sig_props"></a>' >> $OUTPUT
echo "<p> Signature properties: </p>" >> $OUTPUT
$MYSQL --execute="select sum(sig_t) as 't=', sum(sig_x) as 'x=', sum(sig_z) as 'z=' from signatures" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="l_tag"></a>' >> $OUTPUT
echo "<p> Use of 'l=' tag: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as 'l= present', pass from signatures where not siglength = -1 group by pass" >> $OUTPUT
$MYSQL --execute="select count(*) as 'l=0', pass from signatures where siglength = 0 group by pass" >> $OUTPUT
$MYSQL --execute="select count(*) as 'l= < msgsize', pass from signatures join messages on signatures.message = messages.id where signatures.siglength >= 0 and signatures.siglength < messages.size group by pass" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="l_tag"></a>' >> $OUTPUT
echo "<p> Use of 'i=' tag: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as 'messages', case sig_i when 0 then 'absent' when 1 then 'matches d=' when 2 then 'subdomain of d=' end as 'i= domain', case sig_i_user when 0 then 'absent' when 1 then 'empty' when 2 then 'matches From' when 3 then 'does not match From' end as 'i= local-part' from signatures where sig_i >= 0 group by sig_i, sig_i_user" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="key_sizes"></a>' >> $OUTPUT
echo "<p> Distribution of key sizes: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as 'count', keysize as 'bits' from signatures where keysize > 0 group by keysize order by keysize" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="key_props"></a>' >> $OUTPUT
echo "<p> Key properties: </p>" >> $OUTPUT
$MYSQL --execute="select sum(key_t) as 't=', sum(key_g) as 'g=', sum(key_g_name) as 'g=name', sum(key_dk_compat) as 'DK compat' from signatures" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="key_s"></a>' >> $OUTPUT
echo "<p> Use of s= in keys: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as 'keys', case key_s when 0 then 'absent' when 1 then 's=*' when 2 then 's=email' when 3 then 'other' end as 's= value' from signatures where key_s >= 0 group by key_s" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="dnssec"></a>' >> $OUTPUT
echo "<p> DNSSEC results (see libopendkim/dkim.h): </p>" >> $OUTPUT
$MYSQL --execute="select dnssec as 'DNSSEC code', count(*) as count from signatures group by dnssec order by dnssec" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="passfail"></a>' >> $OUTPUT
echo "<p> Overall pass/fail rate for signed mail: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as signatures, sum(ignored) as ignored, sum(pass) as passed, sum(fail_body) as 'failed(body)' from signatures" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="passfail_nolist"></a>' >> $OUTPUT
echo "<p> Overall pass/fail rate for signed mail, excluding list traffic: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as signatures, sum(ignored) as ignored, sum(pass) as passed, sum(fail_body) as 'failed(body)' from signatures join messages on messages.id = signatures.message where messages.mailing_list = 0" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="error_codes"></a>' >> $OUTPUT
echo "<p> Top ten error codes (see libopendkim/dkim.h): </p>" >> $OUTPUT
$MYSQL --execute="select sigerror, count(*) as instances from signatures where not sigerror = 0 and not sigerror = 28 group by sigerror order by instances desc limit 10" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="mlm_comparison"></a>' >> $OUTPUT
echo "<p> MLM/non-MLM signature comparison: </p>" >> $OUTPUT
$MYSQL --execute="select mailing_list, count(*) as signatures, sum(pass) as passed, 100*sum(pass)/count(*) as '%pass' from signatures join messages on messages.id = signatures.message group by messages.mailing_list" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="adsp"></a>' >> $OUTPUT
echo "<p> ADSP policies found and failures: </p>" >> $OUTPUT
$MYSQL --execute="select sum(adsp_found) as found, sum(adsp_unknown) as 'unknown', sum(adsp_all) as 'all', sum(adsp_discardable) as 'discardable', sum(adsp_fail) as 'failed' from messages" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="third_party"></a>' >> $OUTPUT
echo "<p> Author vs. third-party signatures, non-MLM traffic: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as 'author sigs', sum(pass) as 'passed' from signatures join messages on messages.id = signatures.message where messages.from_domain = signatures.domain and messages.mailing_list = 0" >> $OUTPUT
echo "" >> $OUTPUT
$MYSQL --execute="select count(*) as 'third-party sigs', sum(pass) as 'passed' from signatures join messages on messages.id = signatures.message where not messages.from_domain = signatures.domain and messages.mailing_list = 0" >> $OUTPUT

echo '<a name="third_party_list"></a>' >> $OUTPUT
echo "<p> Author vs. third-party signatures, MLM traffic: </p>" >> $OUTPUT
echo "" >> $OUTPUT
$MYSQL --execute="select count(*) as 'author sigs', sum(pass) as 'passed' from signatures join messages on messages.id = signatures.message where messages.from_domain = signatures.domain and messages.mailing_list = 1" >> $OUTPUT
$MYSQL --execute="select count(*) as 'third-party sigs', sum(pass) as 'passed' from signatures join messages on messages.id = signatures.message where not messages.from_domain = signatures.domain and messages.mailing_list = 1" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="signed_fields"></a>' >> $OUTPUT
echo "<p> Signed header field frequency (top 20 shown): </p>" >> $OUTPUT
$MYSQL --execute="select headernames.name, count(signed_headers.id) as count from signed_headers join headernames on headernames.id = signed_headers.header group by signed_headers.header order by count(signed_headers.id) desc limit 20" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="unique_domains"></a>' >> $OUTPUT
echo "<p> Count of unique signed From: domains in sample: </p>" >> $OUTPUT
$MYSQL --execute="select count(distinct from_domain) as domains from messages where anonymized = 0" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="top_signing_domains"></a>' >> $OUTPUT
echo "<p> Top 10 signing domains by signature count: </p>" >> $OUTPUT
$MYSQL --execute="select domains.name, sum(sigcount) as signatures from messages join domains on domains.id = messages.from_domain where anonymized = 0 group by from_domain order by sum(sigcount) desc limit 10" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="top_passing_domains"></a>' >> $OUTPUT
echo "<p> Top 10 signing domains by passing signature percentage: </p>" >> $OUTPUT
$MYSQL --execute="select domains.name, count(*) as signatures, 100*sum(pass)/count(*) as pct_passed from signatures join domains on domains.id = signatures.domain join messages on signatures.message = messages.id where messages.anonymized = 0 group by signatures.domain order by pct_passed desc, signatures desc limit 10" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="top_failing_domains"></a>' >> $OUTPUT
echo "<p> Top 10 signing domains by failed signature percentage: </p>" >> $OUTPUT
$MYSQL --execute="select domains.name, count(*) as signatures, 100-100*sum(pass)/count(*) as pct_failed from signatures join domains on domains.id = signatures.domain join messages on signatures.message = messages.id where messages.anonymized = 0 and signatures.ignored = 0 group by signatures.domain order by pct_failed desc, signatures desc limit 10" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="ip_correlation"></a>' >> $OUTPUT
echo "<p> Correlation of IP addresses to signed From: domains: </p>" >> $OUTPUT
$MYSQL --execute="select ipaddrs.addr, count(distinct from_domain) as domains from messages join ipaddrs on messages.ip = ipaddrs.id where sigcount > 0 and anonymized = 0 group by messages.ip order by domains desc limit 10" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="received_correlation"></a>' >> $OUTPUT
echo "<p> Correlation of Received: count to signature successes: </p>" >> $OUTPUT
$MYSQL --execute="select received_count, sum(sigcount) as 'total sigs', sum(signatures.pass) as 'passed', 100*sum(signatures.pass)/sum(sigcount) as '% pass' from messages join signatures on signatures.message = messages.id where received_count > 0 and sigcount > 0 group by received_count" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="broken_headers"></a>' >> $OUTPUT
echo "<p> Most frequent header field changes resulting in signature failures: </p>" >> $OUTPUT
$MYSQL --execute="select headernames.name, count(headernames.name) as instances from signed_headers join headernames on headernames.id = signed_headers.header where changed = 1 group by signed_headers.header order by instances desc limit 10" >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="worst_adsp"></a>' >> $OUTPUT
echo "<p> Worst ADSP use: </p>" >> $OUTPUT
$MYSQL --execute="SELECT domains.name, a.addr, IF(m.adsp_all, 'all', 'discardable') AS type, SUM(IF(s.pass <> NULL, 0, 1)) AS missing, SUM(IF(s.pass, 0, 1)) AS failed, SUM(IFNULL(s.pass,0)) AS good FROM domains, messages AS m JOIN ipaddrs AS a ON m.ip = a.id LEFT JOIN signatures AS s ON m.id = s.message WHERE domains.id = m.from_domain AND (s.domain = m.from_domain OR s.domain IS NULL) AND m.adsp_all + m.adsp_discardable = 1 GROUP BY m.from_domain, m.ip ORDER BY missing DESC LIMIT 10"  >> $OUTPUT
echo "" >> $OUTPUT

echo '<a name="use_counts"></a>' >> $OUTPUT
echo "<p> Signing domain use counts: </p>" >> $OUTPUT
$MYSQL --execute="select msgcount, count(*) as domains from (select domain, count(*) as msgcount from signatures group by 1) a group by 1 order by 1 asc limit 10" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo '<a name="mime_type_correlation"></a>' >> $OUTPUT
echo "<p> Correlation of outer MIME types with pass/fail counts: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as 'msg count', sum(signatures.pass) as passed, messages.content_type from signatures join messages on signatures.message = messages.id group by messages.content_type" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo '<a name="mime_encoding_correlation"></a>' >> $OUTPUT
echo "<p> Correlation of outer MIME encodings with pass/fail counts: </p>" >> $OUTPUT
$MYSQL --execute="select count(*) as 'msg count', sum(signatures.pass) as passed, messages.content_encoding from signatures join messages on signatures.message = messages.id group by messages.content_encoding" >> $OUTPUT
echo "</p>" >> $OUTPUT

echo '<a name="signing_trend"></a>' >> $OUTPUT
echo "<p> Trend in signing rates </p>" >> $OUTPUT
$MYSQL --execute="select YEAR(msgtime) as year, MONTH(msgtime) as month, (100. * SUM(SIGN(sigcount)) / COUNT(*)) as '% signed' from messages group by year,month order by year,month" >> $OUTPUT
echo "</p>" >> $OUTPUT

# output a footer
echo "<hr>" >> $OUTPUT
echo '<font size="-1"> <i> $Id: opendkim-genstats,v 1.26 2010/10/27 06:18:45 cm-msk Exp $ </i> </font>' >> $OUTPUT
cat >> $OUTPUT << EOF
  </body>
</html>
EOF

# all done!
mv $OUTPUT $REALOUTPUT
exit 0
