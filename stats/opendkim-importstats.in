#!/bin/sh
##
## $Id: opendkim-importstats.in,v 1.2.8.5 2010/08/04 18:48:27 cm-msk Exp $
##
## Copyright (c) 2010, The OpenDKIM Project.  All rights reserved.
##
## opendkim-importstats -- import opendkim-stats output to MySQL
##

## setup
database="opendkim"
user="opendkim"
password="opendkim"
statsdb="/var/db/opendkim/opendkim-stats.db"
anon="yes"

progname=`basename $0`

prefix=@prefix@
datarootdir=@datarootdir@
PACKAGE_TARNAME=@PACKAGE_TARNAME@

## Argument processing
while [ $# -gt 0 ]
do
	case $1 in
	-D)	anon="no"
		;;

	-d)	if [ $# -eq 1 ]
		then
			echo $progname: -d requires a value
			exit 1
		fi

		shift
		database=$1
		;;

	-u)	if [ $# -eq 1 ]
		then
			echo $progname: -u requires a value
			exit 1
		fi

		shift
		user=$1
		;;

	-p)	if [ $# -eq 1 ]
		then
			echo $progname: -p requires a value
			exit 1
		fi

		shift
		password=$1
		;;

	-s)	if [ $# -eq 1 ]
		then
			echo $progname: -s requires a value
			exit 1
		fi

		shift
		statsdb=$1
		;;

	*)	echo $progname: unknown flag $1
		exit 1
		;;
	esac

	shift
done

## capture data
if [ x"$anon" = x"no" ]
then
	anonstr=""
else
	anonstr="-a"
fi

tmpfile=$(mktemp  --tmpdir olddbstore-XXXX.sql)
chmod a+r "${tmpfile}"
if [ x"$statsdb" != x"" ]
then
	opendkim-stats ${anonstr} -c -r "${statsdb}" > "${tmpfile}" || exit 1
fi

mysql --user="${user}" --password="${password}" -e "CREATE DATABASE IF NOT EXISTS \`${database}\`;" || exit 1

mysql --user="${user}" --password="${password}"  "${database}" < @docdir@/mkdb.mysql || exit 1

## construct import command
import="load data infile \"${tmpfile}\"
	into table opendkim_statistics
	lines starting by '='
	(
		jobid,
		from_domain,
		reporter,
		ipaddr,
		anonymized,
		@msgtime,
		algorithm,
		hdr_canon,
		body_canon,
		sigs_total,
		sigs_ignore,
		sigs_pass,
		sigs_fail,
		sigs_fail_body,
		extended,
		key_t,
		key_g,
		key_syntax,
		key_nx,
		key_dk_compat,
		sig_t,
		sig_t_future,
		sig_x,
		sig_l,
		sig_l_zero,
		sig_z,
		dnssec_unknown,
		dnssec_bogus,
		dnssec_insecure,
		dnssec_secure,
		adsp_found,
		adsp_unknown,
		adsp_all,
		adsp_discardable,
		adsp_fail,
		author_sigs,
		author_sigs_fail,
		tp_sigs,
		tp_sigs_fail,
		mailing_list,
		received_count
	) set msgtime = from_unixtime(@msgtime);"

## import
mysql --user="${user}" --password="${password}" -e "${import}" "${database}"

## clean up
rm "${tmpfile}"

exit 0
